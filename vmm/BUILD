load("@rules_rust//rust:defs.bzl", "rust_library", "rust_test")

rust_library(
    name = "vmm",
    srcs = glob([
        "src/*.rs",
        "src/**/*.rs",
        "src/**/**/*.rs",
    ]),
    crate_features = ["kvm"],
    visibility = ["//visibility:public"],
    deps = [
        "//arch",
        "//block",
        "//devices",
        "//event_monitor",
        "//hypervisor",
        "//net_util",
        "//option_parser",
        "//pci",
        "//rate_limiter",
        "//serial_buffer",
        "//tracer",
        "//virtio-devices",
        "//vm-allocator",
        "//vm-device",
        "//vm-migration",
        "//vm-virtio",
        "@acpi-tables//:acpi-tables",
        "@crates//:anyhow",
        "@crates//:arc-swap",
        "@crates//:bitflags",
        "@crates//:cfg-if",
        "@crates//:clap",
        "@crates//:epoll",
        "@crates//:flume",
        "@crates//:igvm_defs",
        "@crates//:landlock",
        "@crates//:libc",
        "@crates//:linux-loader",
        "@crates//:log",
        "@crates//:once_cell",
        "@crates//:seccompiler",
        "@crates//:serde",
        "@crates//:serde_json",
        "@crates//:signal-hook",
        "@crates//:thiserror",
        "@crates//:uuid",
        "@crates//:virtio-queue",
        "@crates//:vm-memory",
        "@crates//:vmm-sys-util",
        "@crates//:zerocopy",
        "@micro-http//:micro-http",
        "@vfio-user//:vfio-user",
        "@vfio//crates/vfio-ioctls",
    ],
)

rust_test(
    name = "vmm_test",
    size = "small",
    srcs = glob([
        "src/*.rs",
        "src/**/*.rs",
        "src/**/**/*.rs",
    ]),
    crate_features = ["kvm"],
    tags = ["nopresubmit"],
    visibility = ["//visibility:public"],
    deps = [
        "//arch",
        "//block",
        "//devices",
        "//event_monitor",
        "//hypervisor",
        "//net_util",
        "//option_parser",
        "//pci",
        "//rate_limiter",
        "//serial_buffer",
        "//tracer",
        "//virtio-devices",
        "//vm-allocator",
        "//vm-device",
        "//vm-migration",
        "//vm-virtio",
        "@acpi-tables//:acpi-tables",
        "@crates//:anyhow",
        "@crates//:arc-swap",
        "@crates//:bitflags",
        "@crates//:cfg-if",
        "@crates//:clap",
        "@crates//:epoll",
        "@crates//:flume",
        "@crates//:igvm_defs",
        "@crates//:landlock",
        "@crates//:libc",
        "@crates//:linux-loader",
        "@crates//:log",
        "@crates//:once_cell",
        "@crates//:seccompiler",
        "@crates//:serde",
        "@crates//:serde_json",
        "@crates//:signal-hook",
        "@crates//:thiserror",
        "@crates//:uuid",
        "@crates//:virtio-queue",
        "@crates//:vm-memory",
        "@crates//:vmm-sys-util",
        "@crates//:zerocopy",
        "@micro-http//:micro-http",
        "@vfio-user//:vfio-user",
        "@vfio//crates/vfio-ioctls",
    ],
)
